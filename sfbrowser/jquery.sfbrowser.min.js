/*
* jQuery SFBrowser 3.4.62
*
* Copyright (c) 2011 Ron Valstar http://www.sjeiti.com/
*
* Dual licensed under the MIT and GPL licenses:
*   http://www.opensource.org/licenses/mit-license.php
*   http://www.gnu.org/licenses/gpl.html
*/
(function($){var oSettings={};var aSort=[];var iSort=0;var bHasImgs=false;var sBase="";var aPath=[];var oTree={};var bOverlay=false;var sFolder;var sReturnPath;var oConstraint;var sBodyOverflow="auto";var bIsOpen=false;var bShortcutsDisabled=false;var $Document=$(document);var $Window;var $Body;var $SFB;var $SFBBg;var $SFBWin;var $TableH;var $Table;var $TbBody;var $TrLoading;var $Dropbox;var $Context;var $Focused;var $CopyPath;var oDragTr;var $DragTr;var $DragTrTable;var oCookie;var oMaximized;var oReg={fileNameNoExt:/(.*)[\/\\]([^\/\\]+)\.\w+$/,fileNameWiExt:/(.*)[\/\\]([^\/\\]+\.\w+)$/};$.sfbrowser={id:"SFBrowser",version:"3.4.62",copyright:"Copyright (c) 2007 - 2012 Ron Valstar",uri:"http://sfbrowser.sjeiti.com/",defaults:{title:"",select:function(a,params){trace(a,params)},selectparams:null,selectnum:0,file:"",folder:"",dirs:true,upload:true,allow:[],resize:null,inline:"body",fixed:false,cookie:false,preview:true,copyRelative:false,bgcolor:"#000",bgalpha:0.5,x:null,y:null,w:640,h:480,img:["gif","jpg","jpeg","png"],ascii:["txt","xml","html","htm","eml","ffcmd","js","as","php","css","java","cpp","pl","log"],movie:["mp3","mp4","m4v","m4a","3gp","mov","flv","f4v"],archive:["zip","rar"],sfbpath:"sfbrowser/",base:"../data/",prefx:"",deny:[],previewbytes:600,connector:"php",lang:{},plugins:[],maxsize:2097152,debug:false},addLang:function(oLang){for(var sId in oLang){$.sfbrowser.defaults.lang[sId]=oLang[sId]}}};$(function(){log(""+$.fn.sfbrowser)});$.fn.extend({sfbrowser:function(_settings){$.extend(oSettings,$.sfbrowser.defaults,_settings);oSettings.connbase="connectors/"+oSettings.connector+"/sfbrowser."+oSettings.connector;oSettings.conn=oSettings.prefx+oSettings.sfbpath+oSettings.connbase;if(oSettings.debug){log("DEBUG")}var aBase=String(window.location).split("/");aBase.pop();sBase=aBase.join("/")+"/";trace("oSettings.conn: ",oSettings,this);if(oSettings.debug){$.sfbrowser.tree=oTree;$.sfbrowser.path=aPath}$Window=$(window);$Body=$("body");oConstraint={mnx:0,mny:0,mxx:$Window.width()-oSettings.w,mxy:$Window.height()-oSettings.h,mnw:244,mnh:275,mxw:$Window.width(),mxh:$Window.height()};getSfbCookie();aSort=[];bHasImgs=oSettings.allow.length===0||unique(copy(oSettings.img).concat(oSettings.allow)).length<(oSettings.allow.length+oSettings.img.length);aPath=[];sFolder=oSettings.base+oSettings.folder;bOverlay=oSettings.inline=="body";if(bOverlay){oSettings.fixed=false}if(oCookie&&oCookie.path&&oCookie.path.length>0){if(sFolder==oCookie.path[0]){aPath=oCookie.path;sFolder=aPath.pop()}}var aFxSfbpath=oSettings.sfbpath.split("/");var aFxBase=oSettings.base.split("/");var iFxLen=Math.min(aFxBase.length,aFxSfbpath.length);var iDel=0;for(var i=0;i<iFxLen;i++){var sFxFolder=aFxBase[i];if(sFxFolder==".."&&aFxSfbpath.length>0){while(true){var sRem=aFxSfbpath.pop();if(sRem!=""){iDel++;break}}}else{if(sFxFolder!=""){aFxBase=aFxBase.splice(iDel,1);break}}}sReturnPath=(aFxSfbpath.join("/")+"//"+aFxBase.join("/")).replace(/(\/+)/,"/").replace(/(^\/+)/,"");$SFB=$(oSettings.browser);$SFBBg=$SFB.find("#fbbg");$SFBWin=$SFB.find("#fbwin:first");$TableH=$SFBWin.find("#fbtable");$Table=$TableH.find("table");$TbBody=$Table.find("tbody");$Dropbox=$SFBWin.find("#dropbox");$Context=$SFB.find("#sfbcontext");setupDropBox();if($.browser.msie){$SFB.addClass("msie")}if(oSettings.debug){$SFB.addClass("debug")}$SFB.find("div.sfbheader>h3").html((oSettings.title==""?gettext("sfb"):oSettings.title)+'<span class="version">'+$.sfbrowser.version+'</span><span class="jquery">jQuery '+$().jquery+'</span><span class="debug">debug mode</span>');$SFB.find("div#loadbar>span").text(gettext("loading"));$SFB.find("#fileToUpload").change(fileManualUpload);var $TopA=$SFB.find("ul#sfbtopmenu>li>a");if(oSettings.dirs){$TopA.filter(".newfolder").click(addFolder).attr("title",gettext("newfolder")).find("span").text(gettext("newfolder"))}else{$TopA.filter(".newfolder").parent().remove()}if(oSettings.upload){$TopA.filter(".upload").attr("title",gettext("upload")).find("span").text(gettext("upload"))}else{$TopA.filter(".upload").parent().remove()}if(!oSettings.fixed){$TopA.filter(".cancelfb").click(closeSFB).attr("title",gettext("cancel")).find("span").text(gettext("cancel"))}else{$TopA.filter(".cancelfb").parent().remove()}if(!oSettings.fixed){$TopA.filter(".maximizefb").click(maximizeSFB).attr("title",gettext("maximize")||"").find("span").text(gettext("maximize")||"")}else{$TopA.filter(".maximizefb").parent().remove()}var $Th=$SFB.find("table#filesDetails>thead>tr>th");$Th.eq(0).text(gettext("name"));$Th.eq(1).text(gettext("type"));$Th.eq(2).text(gettext("size"));$Th.eq(3).text(gettext("date"));$Th.eq(4).text(gettext("dimensions"));if(!bHasImgs){$Th.eq(4).remove()}$Th.filter(":not(:last)").each(function(i,o){$(o).click(function(){sortFbTable(i)})}).append("<span>&nbsp;</span>");if(!oSettings.preview){$SFB.find("#fbpreview").remove()}trace("oSettings.preview: ",oSettings.preview);$SFB.find("div.choose").click(chooseFile).text(gettext("choose"));$SFB.find("div.cancelfb").click(closeSFB).text(gettext("cancel"));if(oSettings.debug){$('<a href="#" class="clearCookie">clear cookie</a>').appendTo($SFBWin.find("div.sfbbotbut")).click(function(){eraseCookie($.sfbrowser.id);trace("cookie cleared",readCookie($.sfbrowser.id))}).css({marginLeft:"10px"})}$SFB.find("#sfbfooter").html('<a href="'+$.sfbrowser.uri+'">'+$.sfbrowser.id+" "+$.sfbrowser.version+" &nbsp; &nbsp; &nbsp; &nbsp; "+$.sfbrowser.copyright+"</a>");$TrLoading=$TbBody.find("tr").clone();$SFBBg.css({backgroundColor:oSettings.bgcolor,opacity:oSettings.bgalpha,filter:"alpha(opacity="+(100*oSettings.bgalpha)+")"});var bSFB=$("#sfbrowser").length>0;if(bSFB){$("#sfbrowser").remove()}$SFB.appendTo(oSettings.inline);if(oSettings.upload){setTimeout(function(){$TopA.filter(".upload").css({display:"inline-block",minWidth:$SFB.find("#fileToUpload").width()-20+"px",textAlign:"left"})},1)}addContextItem("choose",gettext("choose"),function(){chooseFile()});addContextItem("rename",gettext("rename"),function(){renameAddInputField()});addContextItem("duplicate",gettext("duplicate"),function(){duplicateFile()});addContextItem("preview",gettext("view"),function(){$TbBody.find("tr.selected:first a.preview").trigger("click")});addContextItem("filedelete",gettext("del"),function(){$TbBody.find("tr.selected:first a.filedelete").trigger("click")});$SFB.click(closeContext);$CopyPath=$('<input type="text" />').css({position:"fixed"});if(bOverlay){$Window.bind("resize",resizeBrowser);$SFBWin.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return false});$SFB.find("h3").attr("title",gettext("dragMe")).mousedown(moveWindowDown);$SFB.find("div#resizer").attr("title",gettext("dragMe")).mousedown(resizeWindowDown);if(oSettings.x==null){oSettings.x=Math.round($Window.width()/2-$SFBWin.width()/2)}if(oSettings.y==null){oSettings.y=Math.round($Window.height()/2-$SFBWin.height()/2)}$SFBWin.css({top:oSettings.y,left:oSettings.x,width:oSettings.w,height:oSettings.h})}else{trace("sfb inline");$SFBBg.remove();$SFB.find("div#resizer").remove();$SFB.find("div.cancelfb").remove();$SFB.css({position:"relative",width:"auto",heigth:"auto"});$SFBWin.css({position:"relative",border:"0px"});var mPrn=$(oSettings.inline);resizeWindow(0,mPrn.width(),mPrn.height())}setupKeyboardShortcuts();var oThis={trace:trace,openDir:openDir,closeSFB:closeSFB,addContextItem:addContextItem,fillList:fillList,listAdd:listAdd,upDateEntry:upDateEntry,file:file,getPath:getPath,getFilePath:getFilePath,gettext:gettext,lang:lang,resizeWindowDown:resizeWindowDown,moveWindowDown:moveWindowDown,resizeWindow:resizeWindow,onError:onError,sortFbTable:sortFbTable,shortcutsDisabled:shortcutsDisabled,aPath:aPath,bOverlay:bOverlay,oSettings:oSettings,oTree:oTree,oReg:oReg,$Document:$Document,$Window:$Window,$Body:$Body,$SFB:$SFB,$SFBWin:$SFBWin,$TableH:$TableH,$Table:$Table,$TbBody:$TbBody,$TrLoading:$TrLoading,$Context:$Context};$.each(oSettings.plugins,function(i,sPlugin){$.sfbrowser[sPlugin](oThis)});openDir(sFolder);openSFB();trace("SFBrowser open (",oSettings.plugins,")",true)}});$.fn.extend($.fn.sfbrowser,{toString:function(){return"["+$.sfbrowser.id+" "+$.sfbrowser.version+"]"},expose:function(){return !oSettings.debug?{}:{settings:oSettings,openSFB:openSFB,closeSFB:closeSFB,setupKeyboardShortcuts:setupKeyboardShortcuts,keyDown:keyDown,keyUp:keyUp,selectAll:selectAll,getFilePath:getFilePath,addCopyPath:addCopyPath,remCopyPath:remCopyPath,sortFbTable:sortFbTable,fillList:fillList,listAdd:listAdd,upDateEntry:upDateEntry,getTd:getTd,clickTrDown:clickTrDown,mouseMoveTr:mouseMoveTr,clearMoveTr:clearMoveTr,clickTrUp:clickTrUp,chooseFile:chooseFile,openContext:openContext,closeContext:closeContext,previewFile:previewFile,openDir:openDir,onError:onError,duplicateFile:duplicateFile,showFile:showFile,gettext:gettext,cleanUri:cleanUri,formatSize:formatSize}}});function openSFB(){$SFBBg.slideDown();$SFBWin.slideDown("normal",function(){resizeBrowser();resizeWindow();if(oSettings.cookie&&!oCookie){setSfbCookie()}});if(bOverlay){sBodyOverflow=$Body.css("overflow");$Body.css({overflow:"hidden"})}bIsOpen=true}function closeSFB(){trace("sfb close");if(oSettings.cookie){setSfbCookie()}$SFB.find("#fbbg").fadeOut();$SFBWin.slideUp("normal",function(){$SFB.remove()});if(bOverlay){$Body.css({overflow:sBodyOverflow}).scrollTop($Body.scrollTop()+1)}bIsOpen=false}function setupDropBox(){$Dropbox.find(">span").text("Drop here...");var bDropboxVisible=false;function toggleDropBox(b){if(b&&!bDropboxVisible){$Dropbox.removeClass("hover");$Dropbox.css({display:"table"});bDropboxVisible=true}else{if(!b&&bDropboxVisible){$Dropbox.css({display:"none"});bDropboxVisible=false}}}$Window.bind("dragenter dragleave mouseup",function handleWindow(e){e.preventDefault();switch(e.type){case"dragenter":toggleDropBox(true);break;case"dragleave":var iCx=e.originalEvent.clientX;var iCy=e.originalEvent.clientY;if(iCx>0&&iCx<oConstraint.mxw&&iCy>0&&iCy<oConstraint.mxh){break}case"mouseup":}return true});$Dropbox.bind("dragenter dragover drop dragleave",function(e){console.log("handleDropBox",e.type);switch(e.type){case"dragenter":case"dragover":e.preventDefault();break}switch(e.type){case"dragenter":$Dropbox.addClass("hover");break;case"dragleave":$Dropbox.removeClass("hover");break;case"drop":console.log("handleDropBox",e.type,e.originalEvent.dataTransfer.files.length||-1,e);toggleDropBox(false);var oDataTransfer=e.originalEvent.dataTransfer;var oFiles=oDataTransfer.files||oDataTransfer.getData();fileUpload(e.originalEvent.dataTransfer.files);break}})}function setupKeyboardShortcuts(){oSettings.keys=[];$Window.keydown(keyDown);$Window.keyup(keyUp)}function keyDown(e){trace("keyDown: ",e.keyCode,e);oSettings.keys[e.keyCode]=true;var CTRL=oSettings.keys[17];var iNumDown=0;$.each(oSettings.keys,function(i,o){if(o){iNumDown++}});if(!shortcutsDisabled()&&bIsOpen&&iNumDown==1&&$TbBody.find("tr>td>input").length==0&&e.keyCode>=65&&e.keyCode<=90){var sChar=("abcdefghijklmnopqrstuvwxyz").substr(e.keyCode-65,1);var mSel=$TbBody.find("tr.selected:first");var aTbr=$TbBody.find("tr");var iInd=aTbr.index(mSel);if(iInd==-1){iInd=0}var iTbr=aTbr.length;for(var i=1;i<iTbr;i++){var mChk=$(aTbr[(i+iInd)%iTbr]);if(mChk.attr("id").substr(0,1).toLowerCase()==sChar){mChk.mouseup(clickTrUp).mouseup();return false}}}switch(e.keyCode){case 13:if(bIsOpen){chooseFile()}break}if(CTRL){var bReturn=false;switch(e.keyCode){case 81:if(bIsOpen){closeSFB()}break;case 65:if(bIsOpen){selectAll()}break;case 70:if(!bIsOpen&&!bSFB){$.sfb(oSettings)}break;case 67:if(bIsOpen&&$CopyPath.parent().length===0){addCopyPath();setTimeout(remCopyPath,10)}bReturn=true;break;default:bReturn=true}if(bReturn===false){return false}}}function keyUp(e){trace("keyUp: ",e.keyCode,e);if(bIsOpen&&!shortcutsDisabled()&&oSettings.keys[113]){renameAddInputField()}if(bIsOpen&&oSettings.keys[27]){closeSFB()}if((e.keyCode===17||e.keyCode===67)&&$CopyPath.parent().length){remCopyPath()}oSettings.keys[e.keyCode]=false;return false}function selectAll(){$TbBody.find("tr").each(function(){var $Tr=$(this);if(file($Tr).mime!="folderup"&&!$Tr.hasClass("uploading")){$Tr.addClass("selected")}})}function getFilePath(file,relative){return cleanUri((relative?"":sBase)+oSettings.prefx+oSettings.sfbpath+aPath.join("")+file.file)}function addCopyPath(){var $Tr=$TbBody.find("tr.selected:first");if($Tr.length>0){var oExists=getPath().contents[$Tr.attr("id")];var sFilePath=getFilePath(oExists);trace("sFilePath:",sFilePath);$Focused=$(":focus");$CopyPath.prependTo($Body).css({left:oSettings.x+"px",top:oSettings.y+"px"}).val(sFilePath).focus().select()}}function remCopyPath(){$CopyPath.blur().remove();$Focused.focus()}function sortFbTable(nr){if(nr!==undefined){iSort=nr;aSort[iSort]=aSort[iSort]=="asc"?"desc":"asc"}else{if(!aSort[iSort]){aSort[iSort]="asc"}}$TbBody.find("tr.folder").tsort("td:eq(0)[abbr]",{attr:"abbr",order:aSort[iSort]});$TbBody.find("tr:not(.folder)").tsort("td:eq("+iSort+")[abbr]",{attr:"abbr",order:aSort[iSort]});$SFB.find("thead>tr>th>span").each(function(i,o){$Span=$(o);if(i==iSort){$Span.addClass("sort")}else{$Span.removeClass("sort")}if(aSort[iSort]=="asc"){$Span.addClass("asc")}else{$Span.removeClass("asc")}})}function fillList(contents){trace("sfb fillist ",aPath);$TbBody.children().remove();$("#fbpreview").html("");aSort=[];var oCTree=getPath();oCTree.filled=true;if(oSettings.file!=""){var iSfbLn=0;var aSfbP=oSettings.sfbpath.split("/");$.each(aSfbP,function(i,s){if(s!=""){iSfbLn++}});var sPth="";$.each(aPath,function(i,sPath){sPth+=sPath+"///"});sPth=sPth.replace(/(\/+)/g,"/");var aSPth=sPth.split("/");var sRpth="";$.each(aSPth,function(i,sPath){if(i>=iSfbLn){sRpth+=sPath+"/"}});sRpth=sRpth.replace(/(\/+)/g,"/");var sSelFileName=oSettings.file.replace(sRpth,"");var aSeF=oSettings.file.split("/");var iDff=aSeF.length-aPath.length-1}$.each(contents,function(i,oFile){var bDir=(oFile.mime=="folder"||oFile.mime=="folderup");if((oSettings.allow.indexOf(oFile.mime)!=-1||oSettings.allow.length===0)&&oSettings.deny.indexOf(oFile.mime)==-1||bDir){if((bDir&&oSettings.dirs)||!bDir){var mTr=listAdd(oFile);if(oSettings.file!=""&&sSelFileName==oFile.file){mTr.animate({foo:1},{duration:1,complete:function(){mTr.mouseup(clickTrUp).mouseup();oSettings.file=""}})}}}});if(aPath.length>1&&!oCTree.contents[".."]){listAdd({file:"..",mime:"folderup",rsize:0,size:"-",time:0,date:""})}$SFBWin.find("thead>tr>th:eq(0)").trigger("click");applyToPlugins("fillList",[contents]);adjustFilenameWidth();if(oSettings.file!=""&&iDff>0){openDir(aSeF[aPath.length])}}function listAdd(obj,sort){getPath().contents[obj.file]=obj;var bUpload=obj.mime=="upload";var bFolder=obj.mime=="folder";var bUFolder=obj.mime=="folderup";var sMime=bFolder||bUFolder?gettext("folder"):obj.mime;$(document.getElementById(obj.file)).remove();var $Tr=obj.tr=$('<tr id="'+obj.file+'" class="'+(bFolder||bUFolder?"folder":"file")+'">').prependTo($TbBody);var iHo=obj.mime.charCodeAt(0)-97;var iVo=obj.mime.charCodeAt(1)-97;switch(obj.mime){case"folder":iHo=26;iVo=2;break;case"folderup":iHo=28;iVo=2;break;case"odg":iHo=26;break;case"ods":iHo=27;break;case"odp":iHo=28;break}iHo*=-16;iVo*=-16;$('<td abbr="'+obj.file+'" title="'+obj.file+'" class="icon" ><span class="icon" style="background-position: '+iHo+"px "+iVo+'px;" /><span class="filename">'+obj.file+"</span></td>").appendTo($Tr);if(bUpload){$('<td abbr="upload progress" colspan="4"><div class="progress"><div></div><span>0%</span><div></td>').appendTo($Tr);var $TdUpButtons=$("<td />").appendTo($Tr);$('<a class="sfbbutton cancel" title="'+gettext("fileUploadCancel")+'"><span>'+gettext("fileUploadCancel")+"</span></a>").appendTo($TdUpButtons)}else{$('<td abbr="'+obj.mime+'">'+sMime+"</td>").appendTo($Tr);$('<td abbr="'+obj.rsize+'">'+obj.size+"</td>").appendTo($Tr);$('<td abbr="'+obj.time+'" title="'+obj.date+'">'+obj.date.split(" ")[0]+"</td>").appendTo($Tr);if(bHasImgs){var bVImg=(obj.width*obj.height)>0;$("<td"+(bVImg?(' abbr="'+(obj.width*obj.height)+'"'):"")+">"+(bVImg?(obj.width+"x"+obj.height+"px"):"")+"</td>").appendTo($Tr)}var $TdButtons=$("<td />").appendTo($Tr);if(!(bFolder||bUFolder||bUpload)){$('<a onclick="" class="sfbbutton preview" title="'+gettext("view")+'">&nbsp;<span>'+gettext("view")+"</span></a>").appendTo($TdButtons).click(showFile)}if(!(bUFolder||bUpload)){$('<a onclick="" class="sfbbutton filedelete" title="'+gettext("del")+'">&nbsp;<span>'+gettext("del")+"</span></a>").appendTo($TdButtons).click(deleteFile)}}$Tr.folder=bFolder||bUFolder;if(!bUpload){$Tr.mousedown(clickTrDown).mouseover(function(){$Tr.addClass("over")}).mouseout(function(){$Tr.removeClass("over")}).dblclick(function(){chooseFile($(this))})}$Tr[0].oncontextmenu=function(){return false};applyToPlugins("listAdd",[obj]);if(sort&&sort>0){aSort[iSort]=aSort[iSort]=="asc"?"desc":"asc";sortFbTable(iSort);$Tr.mousedown().mouseup();$TableH.scrollTop(0);$TbBody.scrollTop(0)}return $Tr}function upDateEntry(tr,data){var oFile=file(tr);$.each(data,function(s,o){if(oFile[s]!==o){oFile[s]=o;switch(s){case"time":getTd(tr,"date").attr("abbr",data.time).text(data.date.split(" ")[0]).attr("title",data.date);break;case"rsize":getTd(tr,"size").attr("abbr",data.rsize).text(data.size);break;case"width":if(data.width&&data.width){getTd(tr,"dim").attr("abbr",data.width*data.height).text(data.width+" x "+data.height+" px")}break}}})}function getTd(tr,type){return tr.find("td:eq("+$TableH.find("th."+type).index()+")")}var bTrWasSelected=false;var bTrDownHasRenamed=false;var iTrDownT=0;function clickTrDown(e){var $Tr=$(e.currentTarget);$Tr.mouseup(clickTrUp);iTrDownT=new Date().getTime();if($Tr.hasClass("uploading")){return false}var oFile=file($Tr);var bUFolder=oFile.mime=="folderup";var bCTRL=oSettings.keys[17];var bSelected=$Tr.hasClass("selected");bTrWasSelected=bSelected;var iTrY=$Tr[0].offsetTop;var iTbH=$TbBody.height();var iTsc=$TbBody.scrollTop();if(iTrY<iTsc||iTrY>(iTsc+iTbH)){var iAdd=iTrY-(iTsc+0.5*iTbH);var iScr=iTsc+iAdd;$("<br/>").animate({foo:1},{duration:0.1,complete:function(){$TbBody.scrollTop(iScr)}})}bTrDownHasRenamed=renameTryToPost()!==false;if(!bSelected&&!bCTRL){$TbBody.find("tr").removeClass("selected");if(!bUFolder){$Tr.toggleClass("selected")}}var iHTbl=$TableH.height();var iTrTop=$Tr.position().top;if($TbBody.height()>iHTbl||$TbBody.get(0).scrollHeight!=iHTbl){var mScroll=jQuery.browser.mozilla?$TbBody:$TableH;if(iTrTop>iHTbl||iTrTop<0){var iDff=iTrTop>iHTbl?(iTrTop-iHTbl):(iTrTop-2*$Tr.height());mScroll.scrollTop(mScroll.scrollTop()+iDff)}}oDragTr={screenX:e.screenX,screenY:e.screenY,pageX:e.pageX,pageY:e.pageY,offsetX:e.offsetX,offsetY:e.offsetY,layerX:e.layerX,layerY:e.layerY,clientX:e.clientX,clientY:e.clientY};$DragTr=$TbBody.find("tr.selected").add($Tr);$Document.mousemove(mouseMoveTr);$Document.mouseup(clearMoveTr)}function mouseMoveTr(e){var iDx=e.screenX-oDragTr.screenX;var iDy=e.screenY-oDragTr.screenY;var iD=Math.sqrt(iDx*iDx+iDy*iDy);if($DragTrTable===undefined&&iD>20){closeContext();$DragTrTable=$('<table id="sfbDragSelect"></table>').appendTo($SFB);$DragTrTable.append($DragTr.clone());$DragTrTable.find("td:not(:first-child)").remove();$DragTrTable.width("auto")}else{if($DragTrTable!==undefined){$DragTrTable.css({position:"absolute",left:e.clientX+"px",top:e.clientY+20+"px",zIndex:"500"})}}}function clearMoveTr(){$Document.unbind("mouseup",clearMoveTr);$Document.unbind("mousemove",mouseMoveTr);if($DragTrTable!==undefined){var $Rem=$DragTrTable.remove();$DragTrTable=undefined;var $ToTr=$Body.find("tr.over");if($ToTr.length>0){var oToFile=file($ToTr);if(oToFile.mime=="folder"||oToFile.mime=="folderup"){var sFiles="";$Rem.find("tr").each(function(i,el){var $Tr=$(el);var oFromFile=file($Tr);if(oFromFile.mime!="folderup"&&oFromFile!==oToFile){sFiles+=(sFiles==""?"":",")+oFromFile.file}});if(sFiles!=""){$.ajax({type:"POST",url:oSettings.conn,data:"a=moveFiles&folder="+aPath.join("")+"&file="+sFiles+"&nfolder="+oToFile.file,dataType:"json",error:onError,success:function(data,status){if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error));trace(data.data);alert(lang(data.error))}else{trace(lang(data.msg));trace(data.data)}$.each(sFiles.split(","),function(i,s){$TbBody.find("tr").each(function(i,el){var $Tr=$(el);var sId=$Tr.attr("id");if(data.data.moved.indexOf(sId)!==-1){$Tr.remove();var oCurPath=getPath();var aNewPath=copy(aPath);if(data.data.newfolder==".."){aNewPath.pop()}else{aNewPath.push(data.data.newfolder+"/")}getPath(aNewPath).contents[sId]=oCurPath.contents[sId];delete oCurPath.contents[sId]}})})}}})}}}}}function clickTrUp(e){trace("clickTrUp\n\n");var $Tr=$(this);$Tr.unbind("mouseup");var iTrDownUpTime=new Date().getTime()-iTrDownT;if($Tr.hasClass("uploading")){return false}var oFile=file($Tr);var bUFolder=oFile.mime=="folderup";var bCTRL=oSettings.keys[17];var bSelected=$Tr.hasClass("selected");var bRight=e.button==2;clearMoveTr();if(bSelected&&!bCTRL){$TbBody.find("tr").removeClass("selected");if(!bUFolder){$Tr.addClass("selected")}}else{if(bCTRL&&!bUFolder){$Tr.toggleClass("selected")}}if(!bRight&&!bTrDownHasRenamed&&!bCTRL&&!bUFolder&&bTrWasSelected&&$Tr.hasClass("selected")&&iTrDownUpTime>200){renameAddInputField($Tr)}if(bRight){openContext($Tr,e.clientX-3,e.clientY-3)}else{closeContext()}previewFile($Tr);bTrWasSelected=false;bTrDownHasRenamed=false;return false}function chooseFile(el){var i;var oFile;var aSelected=$TbBody.find("tr.selected");var aSelect=[];aSelected.each(function(i,o){if(i<oSettings.selectnum||oSettings.selectnum==0){aSelect.push(file(o))}});if(el&&el.find){aSelect.push(file(el))}for(i=0;i<aSelect.length;i++){oFile=aSelect[i];if(oFile.mime=="folder"){openDir(oFile.file);return false}else{if(oFile.mime=="folderup"){openDir();return false}}}aSelect=unique(aSelect);for(i=0;i<aSelect.length;i++){File=aSelect[i];var oDupl=new Object();for(var p in oFile){oDupl[p]=oFile[p]}aSelect[i]=oDupl}if(aSelect.length==0){alert(gettext("fileNotselected"))}else{if(oSettings.cookie){setSfbCookie()}$.each(aSelect,function(i,oFile){oFile.file=sReturnPath+aPath.join("").replace(oSettings.base,"")+oFile.file});var bSelect=oSettings.select(aSelect,oSettings.selectparams)!==false;if(bSelect&&bOverlay){closeSFB()}}}function openContext($Tr,x,y){var oFile=file($Tr);var bFolder=oFile.mime=="folder";var bUFolder=oFile.mime=="folderup";closeContext(function(){$Context.css({left:x,top:y});var oFld={display:bFolder||bUFolder?"none":"block"};$Context.find("li:has(a.preview)").css(oFld);$Context.find("li:has(a.duplicate)").css(oFld);var oFlu={display:!bUFolder?"block":"none"};$Context.find("li:has(a.rename)").css(oFlu);$Context.find("li:has(a.filedelete)").css(oFlu);applyToPlugins("checkContextItem",[oFile,$Context]);$Context.slideDown("fast")})}function closeContext(fnAfter){$Context.slideUp("fast",typeof(fnAfter)!="function"?function(){}:fnAfter)}function previewFile($Tr){var sFuri;var oFile=file($Tr);var sFile=oFile.file;if($("#fbpreview").length>0&&$("#fbpreview").attr("class")!=oFile.file){$("#fbpreview").html("");var iWprv=$("#fbpreview").width();var iHprv=$("#fbpreview").height();if(oSettings.img.indexOf(oFile.mime)!=-1){sFuri=oSettings.prefx+oSettings.sfbpath+aPath.join("")+sFile;$('<img src="'+sFuri+"?"+Math.random()+'" />').appendTo("#fbpreview").click(function(){$(this).parent().toggleClass("auto")})}else{if(oSettings.ascii.indexOf(oFile.mime)!=-1||oSettings.archive.indexOf(oFile.mime)!=-1||oFile.mime=="pdf"){if(oFile.preview){$("#fbpreview").html(oFile.preview)}else{$("#fbpreview").html(gettext("previewText"));$.ajax({type:"POST",url:oSettings.conn,data:"a=read&folder="+aPath.join("")+"&file="+sFile,dataType:"json",error:onError,success:function(data,status){var sPrv="";if(typeof(data.error)!="undefined"){if(data.error!=""){trace("sfb error: ",lang(data.error),status);alert(lang(data.error))}else{if(data.data.type&&data.data.text){trace(lang(data.msg));var sMsg=data.data.type=="ascii"?gettext("previewPart").replace("#1",oSettings.previewbytes):gettext("previewContents");var sData=data.data.text.replace(/\>/g,"&gt;").replace(/\</g,"&lt;").replace(/(\\r\\n|\\r|\\n)/gi,"<br/>").replace(/\\t/gi,"&nbsp;&nbsp;&nbsp;").replace(/\\\"/gi,'"').replace(/\\'/gi,"'").replace(/\\\\/gi,"\\");oFile.preview="<pre><div>"+sMsg+"</div>\n"+sData+"</pre>";sPrv=oFile.preview}else{trace(lang(data.msg))}}}$("#fbpreview").html(sPrv)}})}}else{if(oFile.mime=="swf"||oFile.mime=="fla"){$("#fbpreview").html('<div id="previewFlash"></div>');swfobject.embedSWF(oSettings.sfbpath+aPath.join("")+sFile,"previewFlash",iWprv+"px",iHprv+"px","9.0.0","",{},{menu:"false"})}else{if(oSettings.movie.indexOf(oFile.mime)!=-1){$("#fbpreview").html('<div id="previewMovie"></div>');sFuri=(oFile.mime=="mp3"?"":"../")+aPath.join("")+sFile;swfobject.embedSWF(oSettings.sfbpath+"css/splayer.swf","previewMovie",iWprv+"px",iHprv+"px","9.0.0","",{file:sFuri,width:iWprv,height:iHprv,gui:"playpause,scrubbar",guiOver:true,colors:'{"bg":"0xFFDEDEDE","bg1":"0xFFBBBBBB","fg":"0xFF666666","fg1":"0xFFD13A3A"}'},{menu:"false"})}}}}$("#fbpreview").attr("class",$("#fbpreview").html()==""?"":oFile.file);return true}return false}function openDir(dir){trace("sfb openDir ",dir," to ",oSettings.conn);if(dir){dir=String(dir+"/").replace(/(\/+)/gi,"/")}if(!dir||aPath[aPath.length-1]!=dir){if(dir){aPath.push(dir)}else{aPath.pop()}var oCTree=getPath();if(oCTree.filled){fillList(oCTree.contents)}else{$TbBody.html($TrLoading);trace("sfb calling fileList");$.ajax({type:"POST",url:oSettings.conn,data:"a=fileList&folder="+aPath.join(""),dataType:"json",error:onError,success:function(data,status){trace("sfb callback fileList");if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error),status);alert(lang(data.error))}else{trace(lang(data.msg));fillList(data.data)}}}})}applyToPlugins("openDir",[dir])}}function onError(req,status,err){trace("sfb ajax error ",req,status,err)}function duplicateFile(el){var oFile=file(el);var sFile=oFile.file;trace("sfb Sending duplication request...");$.ajax({type:"POST",url:oSettings.conn,data:"a=duplicate&folder="+aPath.join("")+"&file="+sFile,dataType:"json",error:onError,success:function(data,status){if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error),status);alert(lang(data.error))}else{trace(lang(data.msg));listAdd(data.data,1).trigger("click")}}}})}function showFile(e){var mTr=$(e.target).parent().parent();var oFile=file(mTr);window.open(oSettings.conn+"?a=download&file="+aPath.join("")+oFile.file,"_blank")}function deleteFile(e){var mTr=$(e.target).parent().parent();var oFile=file(mTr);var bFolder=oFile.mime=="folder";if(confirm(bFolder?gettext("confirmDeletef"):gettext("confirmDelete"))){$.ajax({type:"POST",url:oSettings.conn,data:"a=delete&folder="+aPath.join("")+"&file="+oFile.file,dataType:"json",error:onError,success:function(data,status){if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error),status);alert(lang(data.error))}else{trace(lang(data.msg));$("#fbpreview").html("");applyToPlugins("deleteFile",[e]);delete getPath().contents[oFile.file];mTr.remove()}}}})}e.stopPropagation()}function renameAddInputField(tr){var oFile=file(tr);if(oFile){var $Span=oFile.tr.find("td:eq(0)>span.filename");$Span.html("");var $Input=$('<input type="text" value="'+oFile.file+'" class="sfbrename" />').appendTo($Span).click(stopEvt).dblclick(stopEvt).mousedown(stopEvt).focus();adjustFilenameWidth();var iStart=0;var iPoint=oFile.file.indexOf(".");var iEnd=iPoint==-1?oFile.file.length:iPoint;mInput=$Input.get(0);if(mInput.createTextRange){var selRange=mInput.createTextRange();selRange.collapse(true);selRange.moveStart("character",iStart);selRange.moveEnd("character",iEnd-iStart);selRange.select()}else{if(mInput.setSelectionRange){mInput.setSelectionRange(iStart,iEnd)}else{if(mInput.selectionStart){mInput.selectionStart=iStart;mInput.selectionEnd=iEnd}}}shortcutsDisabled(true)}}function renameTryToPost(){var aRenamed=$TbBody.find("span.filename>input");if(aRenamed.length>0){var mInput=$(aRenamed[0]);var mSp=mInput.parent();var mTr=mSp.parents("tr:first");var oFile=file(mTr);var sFile=oFile.file;var sNFile=mInput.val();if(sFile==sNFile){mSp.html(sFile);shortcutsDisabled(false)}else{$.ajax({type:"POST",url:oSettings.conn,data:"a=rename&folder="+aPath.join("")+"&file="+sFile+"&nfile="+sNFile,dataType:"json",error:onError,success:function(data,status){if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error));alert(lang(data.error));mSp.html(sFile)}else{trace(lang(data.msg));mSp.html(sNFile);oFile.file=sNFile}}shortcutsDisabled(false)}})}}return mTr?mTr:false}function addFolder(){trace("sfb addFolder");$.ajax({type:"POST",url:oSettings.conn,data:"a=addFolder&folder="+aPath.join("")+"&foldername="+gettext("newfolder"),dataType:"json",error:onError,success:function(data,status){if(typeof(data.error)!="undefined"){if(data.error!=""){trace(lang(data.error));alert(lang(data.error))}else{trace(lang(data.msg));listAdd(data.data,1).trigger("click").trigger("click");sortFbTable();$SFB.find("#fbtable").scrollTop(0);$TbBody.scrollTop(0)}}}})}function fileManualUpload(){var $FileToUpload=$SFB.find("#fileToUpload");var sFile=$FileToUpload.val();if(sFile==""){return false}var aFiles=$FileToUpload.prop("files")||[{fileName:sFile,fileSize:null,lastModifiedDate:null,name:sFile,size:null,type:null,webkitRelativePath:""}];fileUpload(aFiles)}function fileUpload(aFiles){$.each(aFiles,function(i,file){trace("sfbupload file",file);var oExists=getPath().contents[file.fileName];if(oExists&&!confirm(gettext("fileExistsOverwrite"))){return false}var $TrUp=listAdd({file:file.fileName,mime:"upload",rsize:0,size:"",time:0,date:"",width:0,height:0}).addClass("uploading");UP.to=oSettings.conn;var oUpload=UP.load(file,{a:"uploading",folder:aPath.join(""),allow:oSettings.allow.join("|"),deny:oSettings.deny.join("|"),resize:oSettings.resize,base64:false}).progress(function(bytesLoaded,bytesTotal){var mPrg=$TrUp.find(".progress");var sPerc=Math.round((bytesLoaded/bytesTotal)*100)+"%";mPrg.find("span").text(sPerc);mPrg.find("div").css({width:sPerc})}).done(function(response){console.log("response",response);$TrUp.remove();var oResponse=jQuery.parseJSON(response);if(oResponse.error!=""){trace("sfb error: ",lang(oResponse.error));alert(lang(oResponse.error))}else{if(oExists){oExists.tr.remove()}var mTr=listAdd(oResponse.data,1);trace("sfb file uploaded: ",oResponse.data.file,mTr[0].nodeName,mTr.attr("id"))}}).error(function(error){console.log("RRR",error);$TrUp.remove()});$TrUp.find("a.cancel").click(function(e){oUpload.abort();$TrUp.remove()})});return false}function loading(){var iPrgMove=Math.ceil((new Date()).getTime()*0.3)%512;$("#loadbar>div").css("backgroundPosition","0px "+iPrgMove+"px");$("#loadbar:visible").each(function(){setTimeout(loading,20)})}function applyToPlugins(sFunction,aParams){$.each(oSettings.plugins,function(i,sPlugin){if($.sfbrowser[sPlugin][sFunction]){$.sfbrowser[sPlugin][sFunction].apply(this,aParams)}})}function file(tr){if(!tr){tr=$TbBody.find("tr.selected:first")}return getPath().contents[$(tr).attr("id")]}function getPath(a){if(a===undefined){a=aPath}var oCTree=oTree;$.each(a,function(i,sPath){if(!oCTree[sPath]){oCTree[sPath]={contents:{},filled:false}}oCTree=oCTree[sPath]});return oCTree}function addContextItem(className,title,fnc,after){var mCItem=$('<li><a class="textbutton '+className+'" title="'+title+'"><span>'+title+"</span></a></li>");if(after===undefined){mCItem.appendTo("ul#sfbcontext").find("a").click(fnc).click(closeContext)}else{mCItem.insertAfter("ul#sfbcontext>li:eq("+after+")").find("a").click(fnc).click(closeContext)}return mCItem}function lang(s){var aStr=s.split("#");sReturn=gettext[aStr[0]]?gettext[aStr[0]]:s;if(aStr.length>1){for(var i=1;i<aStr.length;i++){sReturn=sReturn.replace("#"+i,aStr[i])}}return sReturn}function log(){try{console.log.apply(console,arguments)}catch(e){}}function trace(){if(oSettings.debug===false){return}try{console.log.apply(console,arguments)}catch(e){}}function gettext(s){return oSettings.lang[s]||s}function stopEvt(e){e.stopPropagation()}function shortcutsDisabled(set){if(set!==undefined&&set!==bShortcutsDisabled){bShortcutsDisabled=!!set}return bShortcutsDisabled}function resizeBrowser(){oConstraint.mxw=$Window.width();oConstraint.mxh=$Window.height();oConstraint.mxx=oConstraint.mxw-$SFBWin.width();oConstraint.mxy=oConstraint.mxh-$SFBWin.height();if($("#sfbrowser").length>0){if(bOverlay){if(oMaximized===undefined){var oPos=$SFBWin.position();var iRbX=Math.max(Math.min(oPos.left,oConstraint.mxx),oConstraint.mnx);var iRbY=Math.max(Math.min(oPos.top,oConstraint.mxy),oConstraint.mny);if(iRbX!=oPos.left||iRbY!=oPos.top){moveWindow(null,iRbX,iRbY)}var iRbW=Math.max(Math.min($SFBWin.width(),oConstraint.mxw),oConstraint.mnw);var iRbH=Math.max(Math.min($SFBWin.height(),oConstraint.mxh),oConstraint.mnh);if(iRbW<$SFBWin.width()||iRbH<$SFBWin.height()){resizeWindow(null,iRbW,iRbH)}}else{maximizeSFB(true)}}}}function moveWindowDown(e){var iXo=e.pageX-$(e.target).offset().left;var iYo=e.pageY-$(e.target).offset().top;$("body").mousemove(function(e){moveWindow(e,iXo,iYo)});$("body").mouseup(unbindBody)}function moveWindow(e,xo,yo){var mPrnO=$("#fbbg").offset();var iXps=Math.max(Math.min(e?e.pageX-xo-mPrnO.left:xo,oConstraint.mxx),oConstraint.mnx);var iYps=Math.max(Math.min(e?e.pageY-yo-mPrnO.top:yo,oConstraint.mxy),oConstraint.mny);$SFBWin.css({left:iXps+"px",top:iYps+"px"})}function resizeWindowDown(e){var iXo=e.pageX-$(e.target).offset().left;var iYo=e.pageY-$(e.target).offset().top;$("body").mousemove(function(e){resizeWindow(e,iXo,iYo)});$("body").mouseup(unbindBody);oMaximized=undefined}function resizeWindow(e,xo,yo){var oSPos=$SFB.position();var oWPos=$SFBWin.position();var iWdt=Math.max(Math.min(e?e.pageX+xo-(oWPos.left+oSPos.left):(xo?xo:$SFBWin.width()),oConstraint.mxw),oConstraint.mnw);var iHgt=Math.max(Math.min(e?e.pageY+yo-(oWPos.top+oSPos.top):(yo?yo:$SFBWin.height()),oConstraint.mxh),oConstraint.mnh);$SFBWin.css({width:iWdt+"px",height:iHgt+"px"});var iPrvH=$SFB.find("#fbpreview").height();var iAddH=iPrvH+(iPrvH==null?90:105);$TableH.css({height:(iHgt-iAddH+$Table.find("thead").height())+"px"});$TbBody.css({height:(iHgt-iAddH)+"px"});adjustFilenameWidth();if($Table.width()>$TableH.width()){$Table.find("tr").width($TableH.width())}applyToPlugins("resizeWindow",[iWdt,iHgt])}function maximizeSFB(force){if(oMaximized===undefined||force===true){oMaximized=$SFBWin.position();oMaximized.width=$SFBWin.width();oMaximized.height=$SFBWin.height();moveWindow(null,0,0);resizeWindow(null,$Window.width(),$Window.height())}else{moveWindow(null,oMaximized.left,oMaximized.top);resizeWindow(null,oMaximized.width,oMaximized.height);oMaximized=undefined}}function unbindBody(e){$("body").unbind("mousemove");$("body").unbind("mouseup");if(oSettings.cookie){setSfbCookie()}}function adjustFilenameWidth(){$Filename=$TbBody.find("span.filename");if(!$.browser.msie){$Filename.css({maxWidth:"auto"})}var iOverflow=$Table.width()-$TableH.width();for(var i=0;i<2;i++){var iWmx=$Filename.parents("td:first").width()-20-(i==0?1:0)*iOverflow;if(!$.browser.msie){$Filename.css({maxWidth:iWmx+"px"})}$Filename.find("input").css({width:iWmx+"px"})}}function getSfbCookie(){if(oSettings.cookie){var sCookie=readCookie($.sfbrowser.id);trace("sfb get cookie: "+sCookie);try{oCookie=eval("("+sCookie+")");oSettings.w=Math.min(Math.max(oCookie.w,oConstraint.mnw),oConstraint.mxw);oSettings.h=Math.min(Math.max(oCookie.h,oConstraint.mnh),oConstraint.mxh);oConstraint.mxx=$Window.width()-oSettings.w;oConstraint.mxy=$Window.height()-oSettings.h;oSettings.x=Math.min(Math.max(oCookie.x,oConstraint.mnx),oConstraint.mxx);oSettings.y=Math.min(Math.max(oCookie.y,oConstraint.mny),oConstraint.mxy)}catch(e){trace("sfb cookie error: "+sCookie);eraseCookie($.sfbrowser.id)}}else{eraseCookie($.sfbrowser.id)}return !!oCookie}function setSfbCookie(){var mBg=$("#fbbg");var oBPos=mBg.position();var oPos=$SFBWin.position();var sCval="{";sCval+='"path":["'+aPath.toString().replace(/,/g,'","')+'"]';if(bOverlay){sCval+=',"x":'+(oPos.left-oBPos.left);sCval+=',"y":'+(oPos.top-oBPos.top);sCval+=',"w":'+$SFBWin.width();sCval+=',"h":'+$SFBWin.height()}sCval+="}";trace("sfb set cookie: "+sCval);createCookie($.sfbrowser.id,sCval,356)}function createCookie(name,value,days){var expires="";if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString()}document.cookie=name+"="+value+expires+"; path=/"}function readCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(";");for(var i=0,l=ca.length;i<l;i++){var c=ca[i];while(c.charAt(0)==" "){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)==0){return c.substring(nameEQ.length,c.length)}}return null}function eraseCookie(name){createCookie(name,"",-1)}function cleanUri(path){path=path.replace(/(\/+)/g,"/").replace(/^\//g,"").replace(/tp:\//g,"tp://");while(true){var iLen=path.length;path=path.replace(/[\w_-]+\/\.\.\//g,"");if(iLen===path.length){break}}return path}function formatSize(size,round){if(!round){round=0}aSize=["B","kB","MB","GB","TB","PB","EB","ZB","YB"];for(var i=0,l=aSize.length;size>1024&&l>i;i++){size/=1024}return Math.round(size,round)+aSize[i]}$.sfb=$.fn.sfbrowser})(jQuery);var height_=jQuery.fn.height;jQuery.fn.height=function(){if(this[0]==window&&jQuery.browser.opera&&jQuery.browser.version>=9.5){return window.innerHeight}else{return height_.apply(this,arguments)}};function unique(c){var d=[],e;c.sort();for(e=0,l=c.length;e<l;e++){if(c[e]!==c[e+1]){d[d.length]=c[e]}}return d}function copy(c){var d=[],e=c.length;while(e--){d[e]=c[e].constructor===Array?copy(c[e]):c[e]}return d}if(!Array.indexOf){Array.prototype.indexOf=function(c){for(var b=0,a=this.length;b<a;b++){if(this[b]===c){return b}}return -1}}if(!window.UP){window.UP=function(){var e={load:c,pending:a,to:"uploader.php",toString:function(){return["UP"]}};var b=Array.prototype;var a={toString:function(){return"[uploads "+a.length+"]"},push:function(f){b.push.apply(a,[f])},indexOf:function(f){b.indexOf.apply(a,[f])},splice:function(f){b.splice.apply(a,[f])},remove:function(f){a.splice(a.indexOf(f))},length:0};function d(j){var h="?",f=0;for(var g in j){if(j.hasOwnProperty(g)){h+=(f!==0?"&":"")+g+"="+j[g];f++}}return h}function c(j,r){var k;var n;var p;var m={progress:function(s){k=s;return m},done:function(s){n=s;return m},error:function(s){p=s;return m},fileReader:null,xhr:null};a.push(m);var q=new XMLHttpRequest();q.onreadystatechange=function(s){if(q.readyState!==4){return}a.remove(m);n&&n.apply(this,[q.response||q.responseText])};m.xhr=q;m.abort=function(){q.abort()};if(window.FileReader){function o(u){switch(u.type){case"progress":if(k&&u.lengthComputable){k.apply(this,[u.loaded,u.total])}break;case"loadend":var s=g.result;var v="xxxxxxxxx";if(q.sendAsBinary){r.a="binload";q.open("POST",e.to+d(r),true);q.setRequestHeader("content-type","multipart/form-data; boundary="+v);q.sendAsBinary("--"+v+"\r\nContent-Disposition: form-data; name='upload'; filename='"+j.name+"'\r\nContent-Type: application/octet-stream\r\n\r\n"+s+"\r\n--"+v+"--")}else{r.base64=true;q.open("POST",e.to+d(r),true);q.setRequestHeader("UP-FILENAME",j.name);q.setRequestHeader("UP-SIZE",j.size);q.setRequestHeader("UP-TYPE",j.type);q.send(window.btoa(s))}break;case"error":coUploads.remove(m);if(p){p.apply(this,[u.currentTarget.error])}break}}var g=new FileReader();m.fileReader=g;var f=["loadend","error","progress"];var h=g.addEventListener;for(i=0,iLen=f.length;i<iLen;i++){var t=f[i];if(h){g.addEventListener(t,o,false)}else{g["on"+t]=o}}g.readAsBinaryString(j)}else{q.open("POST",e.to+d(r),true);q.setRequestHeader("UP-FILENAME",j.name);q.setRequestHeader("UP-SIZE",j.size);q.setRequestHeader("UP-TYPE",j.type);q.send(j)}return m}return e}()};